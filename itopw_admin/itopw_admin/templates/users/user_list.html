{% extends "base.html" %}
{% load static i18n %}
{% block title %} {% trans "Members" %} {% endblock %}

{% block styles %}
<link href="{% static 'vendors/custom/datatables/datatables.bundle.css' %}" rel="stylesheet" type="text/css" />
<link href="{% static 'vendors/general/sweetalert2/dist/sweetalert2.css' %}" rel="stylesheet" type="text/css" />
{% endblock styles %}

{% block subheader %}
<div class="kt-subheader   kt-grid__item" id="kt_subheader">
  <div class="kt-container  kt-container--fluid ">
    <div class="kt-subheader__main">
      <h3 class="kt-subheader__title">
        Users
      </h3>
      <span class="kt-subheader__separator kt-subheader__separator--v"></span>
      <div class="kt-subheader__group" id="kt_subheader_search">
        <span class="kt-subheader__desc" id="kt_subheader_total">
          {{total_users}} {% trans 'Total' %} </span>
      </div>
    </div>
    <div class="kt-subheader__toolbar">
      <a href="#" class="">
      </a>
      <a href="demo1/custom/apps/user/add-user.html" class="btn btn-label-brand btn-bold">{% trans 'Add User' %}</a>
    </div>
  </div>
</div>

{% endblock subheader %}

{% block content %}
<div class="kt-container  kt-container--fluid  kt-grid__item kt-grid__item--fluid">

  <!--begin::Portlet-->
  <div class="kt-portlet kt-portlet--mobile">
    <div class="kt-portlet__body kt-portlet__body--fit">

      <!--begin: Datatable -->
      <div class="kt-portlet__body">
        <table class="table table-striped- table-bordered table-hover table-checkable" id="user_list_datatable">
          <!-- <thead>
            <tr>
              <th>ID</th>
              <th>UserName</th>
              <th>Name</th>
              <th>Email</th>
              <th>{% trans 'Status' %}</th>
              <th>{% trans 'Actions' %}</th>
            </tr>
          </thead> -->
        </table>
      </div>

      <!--end: Datatable -->
    </div>
  </div>

  <!--end::Portlet-->

</div>

<div id="table_actions" class="d-none">
  <span class="dropdown">
    <a href="#" class="btn btn-sm btn-clean btn-icon btn-icon-md" data-toggle="dropdown" aria-expanded="true">
      <i class="la la-ellipsis-h"></i>
    </a>
    <div class="dropdown-menu dropdown-menu-right">
      <a class="dropdown-item" href="#"><i class="la la-edit"></i> Edit Details</a>
      <a class="dropdown-item" href="#"><i class="la la-leaf"></i> Update Status</a>
      <a class="dropdown-item" href="#"><i class="la la-print"></i> Generate Report</a>
    </div>
  </span>
  <a href="#" class="btn btn-sm btn-clean btn-icon btn-icon-md" title="View">
    <i class="la la-edit"></i>
  </a>
</div>

<div id="avatar_block" class="d-none">
  <div class="kt-user-card-v2">
      <div class="kt-user-card-v2__pic">
          <div class="kt-badge kt-badge--xl kt-badge--unified-success">__char__</div>
      </div>
      <div class="kt-user-card-v2__details">
          <a class="kt-user-card-v2__name" href="#">__name__</a>
          <!-- <span class="kt-user-card-v2__desc">CEO</span> -->
      </div>
  </div>
</span>

</div>

{% endblock content %}

{% block scripts %}
<script src="{% static 'vendors/custom/datatables/datatables.bundle.js' %}" type="text/javascript"></script>
<!-- begin: Confirm Modal -->
<script src="{% static 'vendors/general/sweetalert2/dist/sweetalert2.min.js' %}" type="text/javascript"></script>
<script src="{% static 'js/confirm_modal.js' %}" type="text/javascript"></script>
<!-- end: Confirm Modal -->
<script>
  "use strict";
  // begin first table
  function loadDataTable() {
    var table = $('#user_list_datatable').DataTable({
      responsive: true,
      pagingType: 'full_numbers',
      searchDelay: 500,
      processing: true,
      serverSide: true,
      ajax: '{% url "user_api:user-list" %}',
      columns: [{
          title: 'ID',
          data: 'id',
        },
        {
          orderable: false,
          title: 'UserName',
          data: 'username',
          render: function (data, type, full, meta) {
            var element = $('#avatar_block').html();
            return element.replace('__char__', full.name_as_avatar).replace('__name__', data);
          },
        },
        {
          orderable: false,
          title: '{% trans "Name" %}',
          data: 'name_verbose',
        },
        {
          orderable: false,
          title: '{% trans "Email" %}',
          data: 'email',
        },
        {
          orderable: false,
          title: '{% trans "Status" %}',
          data: 'active_verbose',
          render: function (data, type, full, meta) {
            if (full.is_active)
              return `<button data-id="${full.id}" data-status="0" class="confirm_change btn btn-brand">${data}</button>`;
            else
              return `<button data-id="${full.id}" data-status="1" class="confirm_change btn btn-danger">${data}</button>`;
          },
        },
        {
          orderable: false,
          title: '{% trans "Actions" %}',
          data: 'id',
          render: function (data, type, full, meta) {
            return $('#table_actions').html();
          },
        },
      ],
    });

    return table;
  }


  function changeActive(e, table, fncFireSuccess) {
    var target = $(e.target);
    $.ajax({
      url: `/api/users/${target.attr('data-id')}`,
      type: 'PUT',
      data: {
        is_active: target.attr('data-status')
      },
      success: (res) => {
        // reload table when success without reload pagination
        table.ajax.reload(null, false);
        fncFireSuccess(); // this callback fire an modal
      },
      error: (jqXHR) => {
        fireError(jqXHR.responseJSON.detail);
      }
    });
  }

  function fireError(msg) {
    swal.fire(
      'Error !!!',
      msg,
      'error'
    )
  }

  jQuery(document).ready(function () {
    var table = loadDataTable();
    confirmChange(function (e, fncFireSuccess) {
      changeActive(e, table, fncFireSuccess)
    }); // this function on partials/confirm_model.htm
  });

</script>
{% endblock scripts %}
